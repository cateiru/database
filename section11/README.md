# 11回目

## トランザクション

- アプリケーションにおけるひとつのまとまった処理
- トランザクション開始から終了までの一連のデータベース操作

### 障害時回復と障害の種類

- トランザクション障害
  - アプリケーションが自主的にトランザクションを取り消す
  - アプリケーションの実行時エラーにより強制終了させられる
  - その他の理由により、トランザクションの続行ができなくなる
- システム障害
  - ハードウェアまたは基本ソフトウェアの問題でシステムが停止し、トランザクションの続行ができなくなる
- メディア（媒体）障害
  - データベースを格納した記憶装置（通常はHDD）が故障し、データの読み書きができなくなる

#### 障害時回復の基本的方法

- トランザクションの後退復帰（UNDO）
  - 異常終了したトランザクションがデータベースに対して行ったすべての更新を取り消す
- システムの後退復帰（UNDO）
  - 障害発生時に未完了（実行中）だったすべてのトランザクションの更新を取り消す
- システムの前進復帰（REDO）
  - 障害発生時に完了済み（正常終了）のすべてのトランザクションの更新を再実行する
- メディア（媒体）復旧（ダンプ、リストア、REDO）
  - あらかじめ記憶装置のバックアップを作成しておき、障害発生時に完了済みのすべてのトランザクションが当該の記憶装置に行ったすべての更新を再実行する

### ログ法

- ログの概念
  - トランザクション、およびシステムがデータベースに対して行った一連の操作の記録
- ログの構成
  - ログ通番（LogSN）、トランザクションID（TransactionID）、操作、対象データ（RelationID + TupleID + ColumnID）、更新前データ（BeforeImage）と更新後のデータ（AfterImage）などからなる
- 重要ポイント
  - ログは、物理的にデータベースとは異なる不揮発性記憶装置に作成する
  - トランザクションは、データベースに更新データを書き込む前に、ログを書き込む（WALプロトコル）
  - トランザクションは、終了する前に、終了状態をログに書き込む

#### WALプロトコル

- データベースに更新データを書き込む前にログを書く方法
- ログさえ残っていれば、ログをもとにデータベースの後退復帰（UNDO）、前進復帰（REDO）が自在に行える

#### 即時更新と遅延更新

- 即時更新
  - データが更新された時点ですぐにデータベースに書き込みに行く方法。
  - ただし、OSがバッファ処理をしているためすぐにディスクに書き込まれる保証はない。
- 遅延更新
  - データが更新されてもすぐにはデータベースに書き込みに行かない方法。
  - バッファが一杯になるか、トランザクションがコミット要求を出した時点でデータベースに書き込みに行く。
  - ただし、この場合もOSがバッファ処理をしているためすぐに書き込まれる保証はない。

### チェックポイント法

- ログの問題点
  - システム障害からの復旧時間の短縮
  - ログのデータ量の圧縮
- チェックポイント法
  - チェックポイントの時点で、システムを一時停止させ、処理途中のデータを含めてデータベース全体のバックアップを取得する
  - 障害が発生した場合にはバックアップを用いてデータベースを障害が発生する直前の状態にする。

#### ダンプとリストア

- ダンプ
  - 物理バックアップ
    - データベースが格納されているファイルをOSのコマンド等を用いて直接コピーする方法
    - 欠点
      - サーバーを停止させる必要がある
      - データベースのファイル構造を熟知している必要がある
  - 論理バックアップ
    - DBMSが提供するコマンド、プログラムを用いて、データベースの内容をバックアップファイルに書き出す方法
    - バックアップファイルの形式には、テキスト形式とバイナリ形式がある
- リストア
  - 物理バックアップ
    - バックアップファイルをデータベースが格納されているファイルにOSのコマンド等を用いて直接上書き
  - 論理バックアップ
    - DBMSが提供しているコマンド、プログラムを用いて、バックアップファイルの内容をデータベースに書き戻す
    - なお、バックアップファイルがテキスト形式の場合は、SQL文の実行が可能なツールも利用できる

- postgreSQL
  - ダンプ

    ```bash
    pg_dump -U postgres database_name > backup_file # txt
    pg_dump -U postgres -Fc database_name > backup_file # bin
    ```

  - リストア

    ```bash
    psql -U postgres database_name < backup_file # txt
    psql -U postgres -C -d database_name < backup_file # bin
    ```
