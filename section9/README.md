# 9回目 正規化理論

## 更新時異状

- リレーションを更新しようとした際に、データの整合性に関する問題が発生する現象
- リレーションの正規化が不十分なときに発生する。

### 種類

- タプル挿入時異状
  - 主キーの制約に抵触するため、タプルを挿入できない現象

    ```log
    SELECT * FROM 商品在庫;
    INSERT 0 7
    商品id |     商品名     |   商品分類   | 販売単価 | 店舗名 | 数量
    --------+----------------+--------------+----------+--------+------
    0001   | Tシャツ        | 衣服         |     1000 | 東京   |   30
    0001   | Tシャツ        | 衣服         |     1000 | 福岡   |  100
    0002   | 穴あけパンチ   | 事務用品     |      500 | 名古屋 |   30
    0002   | 穴あけパンチ   | 事務用品     |      500 | 東京   |   50
    0003   | カッターシャツ | 衣服         |     4000 | 名古屋 |  120
    0003   | カッターシャツ | 衣服         |     4000 | 大阪   |   20
    0004   | 包丁           | キッチン用品 |     3000 | 大阪   |   50
    (7 rows)

    shop=# INSERT INTO 商品在庫 (商品ID,商品名,商品分類,販売単価) VALUES
        ('0005','圧力鍋','キッチン用品',6800);
    ERROR:  null value in column "店舗名" of relation "商品在庫" violates not-null constraint
    DETAIL:  Failing row contains (0005, 圧力鍋, キッチン用品, 6800, null, null).
    ```

- タプル削除時異状
  - タプルの削除時の副作用により、保持したい情報が失われる現象

    ```log
    shop=# DELETE FROM 商品在庫 WHERE 店舗名 = '大阪';
    SELECT * FROM 商品在庫;
    DELETE 2
    商品id |     商品名     | 商品分類 | 販売単価 | 店舗名 | 数量
    --------+----------------+----------+----------+--------+------
    0001   | Tシャツ        | 衣服     |     1000 | 東京   |   30
    0001   | Tシャツ        | 衣服     |     1000 | 福岡   |  100
    0002   | 穴あけパンチ   | 事務用品 |      500 | 名古屋 |   30
    0002   | 穴あけパンチ   | 事務用品 |      500 | 東京   |   50
    0003   | カッターシャツ | 衣服     |     4000 | 名古屋 |  120
    (5 rows)
    ```

- タプル修正時異状
  - 1つの事実を修正するために、複数のタプルを修正する必要が生じる現象。

    ```log
    shop=# UPDATE 商品在庫 SET 販売単価 = 1100
    WHERE 店舗名 = '東京' AND 商品ID = '0001';
    SELECT * FROM 商品在庫;
    UPDATE 1
    商品id |     商品名     | 商品分類 | 販売単価 | 店舗名 | 数量
    --------+----------------+----------+----------+--------+------
    0001   | Tシャツ        | 衣服     |     1000 | 福岡   |  100
    0002   | 穴あけパンチ   | 事務用品 |      500 | 名古屋 |   30
    0002   | 穴あけパンチ   | 事務用品 |      500 | 東京   |   50
    0003   | カッターシャツ | 衣服     |     4000 | 名古屋 |  120
    0001   | Tシャツ        | 衣服     |     1100 | 東京   |   30
    (5 rows)
    ```

## リレーションの分解

- リレーション $R(A_1, ..., A_n)$を2つのリレーション$S(A_{S1}, ..., A_{Sm})$と$T(A_{T1}, ..., T_{T1})$に分解すること

    例:

    ```sql
    create table 商品在庫 (
        商品ID char(4) not null,
        商品名 varchar(100) not null,
        商品分類 varchar(32) not null,
        販売単価 integer,
        店舗名 varchar(200),
        数量 integer,
        primary key (商品ID, 店舗名);
    )
    ```

    ↓

    ```sql
    create table 商品1 (
        商品ID char(4) not null,
        商品名 varchar(100) not null,
        商品分類 varchar(32) not null,
        販売単価 integer,
        店舗名 varchar(200),
        primary key (商品ID, 店舗名);
    )

    create teble 在庫1 (
        商品名 varchar(100) not null,
        数量 integer,
        primary key (店舗名);
    )
    ```

- 情報無損失分解
  - 分解された2つのリレーションを自然結合することによって、元のリレーションが復元できるような分解

    例:

    ```sql
    create table 商品在庫 (
        商品ID char(4) not null,
        商品名 varchar(100) not null,
        商品分類 varchar(32) not null,
        販売単価 integer,
        店舗名 varchar(200),
        数量 integer,
        primary key (商品ID, 店舗名);
    )
    ```

    ↓

    ```sql
    create table 商品1 (
        商品ID char(4) not null,
        商品名 varchar(100) not null,
        商品分類 varchar(32) not null,
        販売単価 integer,
        店舗名 varchar(200),
        primary key (商品ID, 店舗名);
    )

    create teble 在庫1 (
        商品ID char(4) not null,
        店舗名 varchar(200),
        数量 integer,
        primary key (店舗名);
    )
    ```

## 関数従属性（FD）

- ある属性の値が決まると、対応する別の属性の値が**一意**に決まる性質

```log
shop=# select * from 商品在庫;
 商品id |     商品名     |   商品分類   | 販売単価 | 店舗名 | 数量
--------+----------------+--------------+----------+--------+------
 0001   | Tシャツ        | 衣服         |     1000 | 東京   |   30
 0001   | Tシャツ        | 衣服         |     1000 | 福岡   |  100
 0002   | 穴あけパンチ   | 事務用品     |      500 | 名古屋 |   30
 0002   | 穴あけパンチ   | 事務用品     |      500 | 東京   |   50
 0003   | カッターシャツ | 衣服         |     4000 | 名古屋 |  120
 0003   | カッターシャツ | 衣服         |     4000 | 大阪   |   20
 0004   | 包丁           | キッチン用品 |     3000 | 大阪   |   50
(7 rows)
```

- $f_1 : \{商品ID\} → \{商品名\}$
- $f_2 : \{商品ID\} → \{商品分類\}$
- $f_3 : \{商品ID\} → \{販売単価\}$
- $f_4 : \{商品ID, 店舗名\} → \{数量\}$

## 公理系

- 命題を導き出すための前提として導入されるもっとも基本的な仮定のこと。
- 議論の前提として置かれる一連の公理の集まり

- `a = a` (反射律)
- `a + b = b + a` (交換律)
- `a * (b + c) = a * b + a * c` (分解律)
- `a > b ならば  a + c > b + c` (添加律)
- `a > b かる b > c ならば a > c` (推移律)

- アームストロングの公理
  - 反射律: $Y ⊆ X ならば X → Y$
  - 添加律: $X → Y ならば (X ∪ Z) → (Y ∪ Z)$
  - 推移律: $X → Y かつ Y → Z ならば X → Z$

## 第2正規形

- 第1正規形（1NFでありかつ、主キーに属さないすべての属性は、主キーの真部分集合に関数従属でない。
- 部分従属$X⊂K, X → A$となるような属性集合Xが存在しない。

## 第3正規形

- 第2正規形(2NF)でありかつ、主キーに属さないすべての属性は主キー以外の属性に関数従属でない。
- 推移従属$K → X, X → A$となるような属性集合Xが存在しない。
