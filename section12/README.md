# 12回目 トランザクションの同時実行制御

## トランザクションの同時実行

- トランザクションのモデル化
  - begin: トランザクション開始
  - read(x): データ(x)を読み込む
  - write(y): データ(y)を書き込む
  - commit: トランザクションを正常終了する（更新確定）
  - rollback: トランザクションを異常終了する（取り消し）
- スケジュール（history or schedule）
  - 基本操作の実行系列

### トランザクションの実行方法

- 直列実行（逐次処理: serial processing）
  - トランザクションを1つずつ順に実行する
  - 実行順序によって、異なる結果となる場合がある
  - トランザクション同士が相互に干渉しあうことはない
  - 単位時間内に実行可能なトランザクション数は少ない
- 同時実行（並列処理: concurrent/parallel processing）
  - トランザクションを複数同時に実行する
  - 実行順序によって、異なる結果となる場合がある
  - トランザクション同士が相互に干渉しあうことがある
  - 単位時間内に実行可能なトランザクション数は多い

#### 同時実行により生じる異状

- 遺失更新異状（lost update）
  - **現象**: 更新データが喪失する
  - **原因**: 他のトランザクションによって更新データが上書きされてしまうため
- 不整合検索異状（inconsistent read）
  - **現象**: 一貫性のないデータを読んでしまう
  - **原因**: 他のトランザクションが更新している前後両方のデータを読んでしまうため
- 汚読異状（dirty read）
  - **現象**: 本当の値とは異なる誤ったデータを読んでしまう
  - **原因**: 他のトランザクションが更新途中に未確定データを読んでしまうため

#### 直列化可能

- 直列化可能
  - トランザクションを同時実行するスケジュールとトランザクションを直列実行するスケジュールが等価な場合
  - 一般に直列スケジュールは複数あるので、等価な直列スケジュールが1津でもあれば直列化可能
- 相反
  - 実行順序によってトランザクションの処理結果が変わる可能性のある基本操作
- 相反グラフ
  - トランザクションをノード、トランザクション間の相反をエッジとして表現した有向グラフ

### SQLトランザクションの隔離性水準

psqlデフォルト: READ COMMITTED

- READ UNCOMMITTED
  - 確定していない値を読む可能性がある
- READ COMMITTED
  - 確定している値だけを読むことを保証
- REPEATABLE READ
  - 複数回読んだときに、毎回同じ値を読むことを保証する
- SERIALIZABLE
  - 直列化可能であることを保証

### 2相ロック法

- 施錠する
