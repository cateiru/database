# 8回目 データベース設計

## はじめに

- エドガー・F・コッド(Edgar F. Codd)
  - 1981年、ACM Turing Award 受賞
  - リレーショナルデータベースの理論確立
- リレーショナルデータベースの目標
  - データベースを管理する際の論理的、物理的な問題の境界線を明確にすする。
    - データ独立性
  - 構造の単純化
  - 高水準言語の導入

### データベース理論とSQLの用語対応

|     DB理論の用語     |          SQLの用語           |                                         概念の相違点                                         |
| :------------------: | :--------------------------: | :------------------------------------------------------------------------------------------: |
|  関係、リレーション  |         表、テーブル         |              関係は集合であるが、SQLの表は集合ではない。（重複化、順女性あり）               |
| 属性、アトリビュート |          列、カラム          |                                                                                              |
|      組、タプル      |           行、ロー           |                                                                                              |
|   定義域、ドメイン   |           データ型           |                                                                                              |
|        属性値        |           データ値           | 属性値は単純でなければならない（1NF）が、SQLのデータ値は単純でなくても良い（組や集合も饗応） |
|         次数         |             列数             |                                                                                              |
|         基数         |             行数             |                                                                                              |
|       スキーマ       | 表定義、スキーマ、メタデータ |                                                                                              |
|     インスタンス     |          （表実態）          |          SQLのインスタンスは、処理を行うプロセス（スレッド）を意味する場合がある。           |

## 第一正規形

- is何
  - ドメインの各値が、文化不可能な単純値のみのリレーション
  - =1NF
- 特徴
  - 構造が簡潔
  - 意味が明快
  - データ操作が単純
- それ以外
  - 非第一正規形
- メリット
  - 簡明
  - 操作体系の最小化
- デメリット
  - 冗長なデータが格納される可能性

### 正規化

- is何
  - 正規形になっていないリレーションを正規形に変換すること

### 非第一正規形

非第一正規形の例:

| キャンパス |         住所          |
| :--------: | :-------------------: |
|    千住    | 120-8551 東京都足立区 |
|    鳩山    | 035-0394 埼玉県鳩山町 |
|    千葉    | 270-1382 千葉県印西市 |

- 属性値自身がタプルになっている
  - 例: 住所が`郵便番号+都道府県...`
  - 属性内のタプルを個別の属性に分解する
- 属性値が配列または集合担っている
  - 例: 趣味が`野球+盆栽...`
  - 異なるタプルに格納する
- タプルごとに属性の数や順序が異なっている
  - 例: Javaにおける凹凸のある2次元配列
  - 属性値のない場合はNULLを格納し、属性の数と順序を統一
- 属性値が異なる属性またはタプルで共有
  - 例: Excelにおける複数セル結合
  - 個別の属性に分解してコピーする

## 主キーと外部キー

### 主キー

- is何
  - まったく同じタプルが存在しない組み合わせの属性
- 条件
  - タプルを一意に識別できる属性の組
  - 不要な属性を含まない極小の組
  - 各属性値は空値（null value）をとらない
- 候補キー
  - 主キーとなることができる他の属性

### 外部キー

- 条件
  - 他のリレーションの主キーと同じ属性の組
  - 各属性値が空値（null value）である、または他のリレーション中に同一の属性値を主キーとして持つタプルが存在する

### 制約違反

```log
 部門番号 | 部門名 | 部屋番号
----------+--------+----------
 K01      | 人事部 |      401
 K02      | 営業部 |      301
 K03      | 広報部 |      201
(3 rows)

 社員番号 |   氏名   | 年齢 | 所属 | 役職
----------+----------+------+------+------
 E001     | 一橋市郎 |   51 | K02  |
 E002     | 二宮次郎 |   49 | K02  | 部長
 E003     | 三島充希 |   49 | K03  | 部長
 E004     | 四谷史郎 |   40 | K01  | 部長
 E005     | 五味剛太 |   38 | K02  |
 E006     | 六郷睦美 |   30 | K03  |
 E007     | 七尾菜々 |   29 | K01  |
 E008     | 八坂弥助 |   23 |      |
 E009     | 九鬼久美 |   22 |      |
(9 rows)
```

- 主キー
  - `insert into 社員 values ('E003', '三田美香', 57, null, null);`
    - Error: `キー("社員番号")=(E003)はすでに存在します`
  - `update 社員 set 社員番号 = null where 社員番号 = 'E009';`
    - Error: `失敗した行は(null, 九鬼久美, 22, null, null)を含みます`
- 外部キー
  - `insert into 社員 values ('E010', '十朱当麻', 57, 'K04', null);`
    - Error: `テーブル"部門"にキー(所属)=(K04)がありません`
  - `delete from 部門 where 部門番号 = 'K01;`
    - Error: `キー(部門番号)=(K01)はまだテーブル"社員"から参照されています`

## データモデリング

- is何
  - 複雑かつ膨大な実世界の情報の中から、企業活動にひつよな情報のみを単純化された形で抽出し、データベーススキーマを定義すること
- 流れ
  - 概念モデリング → 理論モデリング

### 概念モデル

- 実世界のデータ構造を認識し、ある記号系を用いて記述されたもの
- オブジェクト指向モデル、実体 - 関連モデル等

### 論理モデル

- データベース管理システム（DBMS）で管理可能な記号系を用いて記述されたもの（スキーマ）
- ネットワークデータモデル、ハイアラキカルデータモデル、リレーショナルデータモデル

## 実体関連モデルと実体関連図

### 実体関連モデル

- is何
  - 1976年、P.P.チェンが発表
  - ERモデルとも
- 実体型
  - 業務で扱う個々の顧客、商品、設備などの具体的な事物。
  - 具体的な事物といっても、必ずしも目に「**見える**」ものとは限らない。
  - 一般的→名詞句から抽出。例: 社員、部門、給料、研修 ...
  - 一方、事物の名称（顧客名、商品名）や特徴、状態→**実体型の属性**
- 関連型
  - 2つ以上の実体型間の相互関係を表したもの。
  - 1:1、1:etc、etc:etcの3種類
  - 一般的→動詞句から抽出。例: 所属、支給、受講、使用 ...
  - 一方、関連に参加する実体の役割（派遣社員として勤務）→**関連型の属性**
- 実体関連図で表す

![image](https://lh3.googleusercontent.com/proxy/eh4JOBF9sWSbZz3aMoGNId_dTNAn34APrZY7ncS0RErUuyqYoHL4aTXX8hh9xhriSJNSqqeGJeizJLFXfgGXklN1P8q38KMmiWfqg1TG)

## リレーショナルスキーマへの変換

略
